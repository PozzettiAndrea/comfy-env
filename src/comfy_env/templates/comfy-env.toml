# =============================================================================
# comfy-env.toml - Environment configuration for ComfyUI custom nodes
# Documentation: https://github.com/PozzettiAndrea/comfy-env
# =============================================================================
#
# This file configures dependencies for your ComfyUI custom node.
# comfy-env handles two main challenges:
#   1. Installing CUDA packages that require compilation (nvdiffrast, pytorch3d, etc.)
#   2. Running nodes in isolated environments with their own dependencies
#
# Quick start:
#   pip install comfy-env
#   comfy-env init          # Creates this template
#   comfy-env install       # Installs dependencies
#   comfy-env doctor        # Verifies installation


# =============================================================================
# SYSTEM PACKAGES (optional)
# =============================================================================
# System-level packages installed via apt (Linux) before Python packages.
# Useful for packages that need system libraries to compile or run.

[system]
linux = []
# Examples:
# linux = ["libgl1", "libopengl0"]     # For OpenGL rendering (nvdiffrast)
# linux = ["python3-dev"]               # For packages that compile C extensions
# linux = ["ffmpeg"]                    # For video processing nodes


# =============================================================================
# CUDA PACKAGES
# =============================================================================
# CUDA packages from the built-in registry. These are pre-compiled wheels
# that install without needing a compiler. Run `comfy-env list-packages`
# to see all available packages.

[cuda]
# Use exact package names from `comfy-env list-packages` (hyphens vs underscores matter!)
# nvdiffrast = "0.4.0"       # NVIDIA differentiable rasterizer
# pytorch3d = "0.7.9"        # PyTorch3D - 3D deep learning
# gsplat = "1.5.3"           # Gaussian splatting rasterization
# torch-scatter = "2.1.2"    # PyG scatter operations
# torch-cluster = "1.6.3"    # PyG clustering algorithms
# flash-attn = "2.7.4"       # Flash Attention (Linux x86_64 only)
# spconv = "2.3.8"           # Sparse convolution library
# sageattention = "2.2.0"    # SageAttention - faster than FlashAttention
# dpvo_cuda = "0.0.0"        # DPVO CUDA extensions


# =============================================================================
# REGULAR PACKAGES
# =============================================================================
# Standard pip packages (no special CUDA handling needed).

[packages]
requirements = []
# Examples:
# requirements = [
#     "transformers>=4.56",
#     "pillow",
#     "opencv-python-headless",
#     "trimesh",
# ]


# =============================================================================
# CUSTOM WHEEL SOURCES (optional)
# =============================================================================
# Override built-in wheel URLs or add packages not in the registry.
# Template variables: {version}, {cuda_short}, {torch_mm}, {py_tag}, {platform}

[wheel_sources]
# my-custom-package = "https://my-server.com/my-package-{version}+cu{cuda_short}-{py_tag}-{platform}.whl"


# =============================================================================
# NODE DEPENDENCIES (optional)
# =============================================================================
# Other ComfyUI custom nodes this node depends on.

[node_reqs]
# VideoHelperSuite = "Kosinkadink/ComfyUI-VideoHelperSuite"
# ComfyUI-Impact-Pack = "ltdrdata/ComfyUI-Impact-Pack"


# =============================================================================
# EXTERNAL TOOLS (optional)
# =============================================================================
# External applications required by the node.

[tools]
# blender = "4.2"


# #############################################################################
#
#                       PROCESS ISOLATION (ADVANCED)
#
# #############################################################################
#
# For nodes that need completely isolated dependencies (different Python
# version, conda packages, conflicting native libraries), define an isolated
# environment with `isolated = true`.
#
# RECOMMENDED: Pack-wide isolation (all nodes in one environment)
# ----------------------------------------------------------------
# This is the simplest approach - all your nodes run in the same isolated env.
#
# Step 1: Define environment in comfy-env.toml (this file)
# Step 2: In __init__.py:
#
#     from comfy_env import setup_isolated_imports, enable_isolation
#
#     # Setup import stubs BEFORE importing nodes
#     setup_isolated_imports(__file__)
#
#     from .nodes import NODE_CLASS_MAPPINGS, NODE_DISPLAY_NAME_MAPPINGS
#
#     # Enable isolation for all nodes
#     enable_isolation(NODE_CLASS_MAPPINGS)
#
# =============================================================================


# -----------------------------------------------------------------------------
# Example: Full pack isolation with conda packages (RECOMMENDED)
# -----------------------------------------------------------------------------
# Uses pixi to create an isolated environment with conda + pip packages.

# [mypack]
# python = "3.11"
# isolated = true           # Required for enable_isolation()
#
# [mypack.conda]
# channels = ["conda-forge"]
# packages = ["cgal", "openmesh"]
#
# [mypack.packages]
# requirements = ["trimesh[easy]>=4.0", "numpy", "scipy"]


# -----------------------------------------------------------------------------
# Example: Multiple isolated environments (per-node control)
# -----------------------------------------------------------------------------
# Use @isolated(env="envname") decorator when different nodes need different envs.
#
#     from comfy_env import isolated
#
#     @isolated(env="env-preprocessing")
#     class PreprocessNode: ...
#
#     @isolated(env="env-inference")
#     class InferenceNode: ...

# [env-preprocessing]
# python = "3.11"
#
# [env-preprocessing.packages]
# requirements = ["opencv-python-headless", "pillow"]

# [env-inference]
# python = "3.10"
#
# [env-inference.cuda]
# torch-scatter = "2.1.2"


# -----------------------------------------------------------------------------
# Example: Platform-specific packages
# -----------------------------------------------------------------------------
# Different packages for Windows vs Linux.

# [crossplatform]
# python = "3.11"
# isolated = true
#
# [crossplatform.packages]
# requirements = ["numpy", "pillow"]
#
# [crossplatform.packages.windows]
# requirements = ["pywin32"]
#
# [crossplatform.packages.linux]
# requirements = ["python-xlib"]
